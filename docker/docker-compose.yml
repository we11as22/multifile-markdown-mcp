version: '3.8'

services:
  # PostgreSQL with pgvector extension
  postgres:
    image: pgvector/pgvector:pg16
    container_name: agent-memory-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-agent_memory}
      POSTGRES_USER: ${POSTGRES_USER:-memory_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me_in_production}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-memory_user} -d ${POSTGRES_DB:-agent_memory}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - agent-memory-net
    restart: unless-stopped

  # Ollama for local embeddings
  ollama:
    image: ollama/ollama:latest
    container_name: agent-memory-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - agent-memory-net
    restart: unless-stopped
    # Uncomment to auto-pull embedding model on startup
    # command: |
    #   /bin/sh -c "
    #   ollama serve &
    #   sleep 5 &&
    #   ollama pull nomic-embed-text &&
    #   wait
    #   "

  # MCP Server
  mcp-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: agent-memory-mcp
    environment:
      # Server
      - MCP_SERVER_NAME=${MCP_SERVER_NAME:-agent-memory}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Storage
      - MEMORY_FILES_PATH=/app/memory_files
      - MAIN_FILE_NAME=${MAIN_FILE_NAME:-main.md}

      # Database (optional - set USE_DATABASE=false to disable)
      - USE_DATABASE=${USE_DATABASE:-true}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-agent_memory}
      - POSTGRES_USER=${POSTGRES_USER:-memory_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-change_me_in_production}

      # Embedding Provider
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
      - EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION:-1536}

      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_EMBEDDING_MODEL=${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}

      # Cohere
      - COHERE_API_KEY=${COHERE_API_KEY}
      - COHERE_EMBEDDING_MODEL=${COHERE_EMBEDDING_MODEL:-embed-english-v3.0}

      # Ollama
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_EMBEDDING_MODEL=${OLLAMA_EMBEDDING_MODEL:-nomic-embed-text}

      # HuggingFace
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - HUGGINGFACE_MODEL=${HUGGINGFACE_MODEL:-sentence-transformers/all-MiniLM-L6-v2}

      # LiteLLM
      - LITELLM_MODEL=${LITELLM_MODEL:-text-embedding-3-small}

      # Search
      - CHUNK_SIZE=${CHUNK_SIZE:-800}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - SEARCH_LIMIT=${SEARCH_LIMIT:-20}
      - RRF_K=${RRF_K:-60}

      # Sync
      - FILE_WATCH_ENABLED=${FILE_WATCH_ENABLED:-true}
      - SYNC_INTERVAL_SECONDS=${SYNC_INTERVAL_SECONDS:-60}

      # Advanced
      - DB_POOL_MIN_SIZE=${DB_POOL_MIN_SIZE:-5}
      - DB_POOL_MAX_SIZE=${DB_POOL_MAX_SIZE:-20}
      - EMBEDDING_BATCH_SIZE=${EMBEDDING_BATCH_SIZE:-100}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - RETRY_BACKOFF_FACTOR=${RETRY_BACKOFF_FACTOR:-2}
    volumes:
      # Mount memory files directory (bidirectional sync)
      - ../memory_files:/app/memory_files
      # Mount logs directory
      - mcp_logs:/app/logs
    ports:
      # Expose for stdio transport (optional)
      - "8000:8000"
    depends_on:
      # PostgreSQL is optional - only required if USE_DATABASE=true
      # If USE_DATABASE=false, start only mcp-server: docker-compose up -d mcp-server
      postgres:
        condition: service_healthy
      ollama:
        condition: service_started
    networks:
      - agent-memory-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  # Persistent PostgreSQL data
  postgres_data:
    driver: local

  # Persistent Ollama models
  ollama_data:
    driver: local

  # MCP server logs
  mcp_logs:
    driver: local

networks:
  agent-memory-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
